{% extends "staff/base_staff.html" %}
{% load i18n %}
{% block staff_title %}{% trans "Nouvelle mission — Staff" %}{% endblock %}

{% block staff_content %}
<section class="space-y-4 max-w-5xl mx-auto">
  <!-- En-tête -->
  <header class="flex items-center justify-between">
    <h1 class="text-2xl font-extrabold text-blue-700 dark:text-blue-300">
      {% trans "Nouvelle mission" %}
    </h1>
    <a href="{% url 'staff:mission_list' %}"
       class="px-3 py-2 rounded-lg ring-1 ring-slate-200 hover:bg-slate-50
              dark:ring-white/10 dark:hover:bg-white/5 text-sm">
      ← {% trans "Retour" %}
    </a>
  </header>

  <form id="mission-form" method="post" enctype="multipart/form-data"
        class="auth-key-form js-auth-managed bg-white dark:bg-slate-900 rounded-2xl shadow ring-1 ring-black/5 dark:ring-white/10 p-6 space-y-6"
        data-auth-message="Clé requise pour créer ou modifier une mission."
        data-superuser="{{ request.user.is_superuser|yesno:'true,false' }}"
        novalidate>
    {% csrf_token %}

    {# Erreurs globales #}
    {% if form.non_field_errors %}
      <div class="p-3 rounded-lg bg-rose-50 text-rose-800 border border-rose-200
                  dark:bg-rose-900/30 dark:text-rose-200 dark:border-rose-900/40">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    {# Sommaire (facultatif) #}
    {% if form.errors %}
      <div class="p-3 rounded-lg bg-amber-50 text-amber-900 border border-amber-200 dark:bg-amber-900/20 dark:text-amber-100 dark:border-amber-900/40">
        <ul class="list-disc list-inside text-sm">
          {% for field in form %}
            {% if field.errors %}
              <li><a href="#{{ field.id_for_label }}" class="underline">{{ field.label }}:</a> {{ field.errors|join:", " }}</li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Titre (plein) -->
      <div class="md:col-span-2">
        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Titre" %}
        </label>
        {{ form.title }}
        {% if form.title.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.title.errors.0 }}</p>{% endif %}
      </div>

      <!-- Lieu -->
      <div>
        <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Lieu" %}
        </label>
        {{ form.location }}
        {% if form.location.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.location.errors.0 }}</p>{% endif %}
      </div>

      <!-- Événement -->
      <div>
        <label for="{{ form.event.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Événement" %}
        </label>
        {{ form.event }}
        {% if form.event.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.event.errors.0 }}</p>{% endif %}
        <p id="eventPreview" class="mt-1 text-xs text-slate-500 dark:text-slate-400"></p>
      </div>

      <!-- Début -->
      <div>
        <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Début" %}
        </label>
        {{ form.start_date }}
        {% if form.start_date.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.start_date.errors.0 }}</p>{% endif %}
      </div>

      <!-- Fin -->
      <div>
        <label for="{{ form.end_date.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Fin" %}
        </label>
        {{ form.end_date }}
        {% if form.end_date.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.end_date.errors.0 }}</p>{% endif %}
      </div>

      <!-- Capacité -->
      <div>
        <label for="{{ form.capacity.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Capacité" %}
        </label>
        {{ form.capacity }}
        {% if form.capacity.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.capacity.errors.0 }}</p>{% endif %}
      </div>

      <!-- Statut (plein) -->
      <div class="md:col-span-2">
        <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Statut" %}
        </label>
        {{ form.status }}
        {% if form.status.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.status.errors.0 }}</p>{% endif %}
      </div>

      <!-- Description (plein) -->
      <div class="md:col-span-2">
        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">
          {% trans "Description" %}
        </label>
        {{ form.description }}
        {% if form.description.errors %}<p class="mt-1 text-sm text-rose-600">{{ form.description.errors.0 }}</p>{% endif %}
      </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">

</div>
    <!-- Barre d’actions sticky -->
    <div class="sticky bottom-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur
                border-t border-slate-200 dark:border-white/10 -mx-6 px-6 py-3
                rounded-b-2xl flex items-center justify-between">
      <p class="text-xs text-slate-500 dark:text-slate-400">
        {% trans "Vérifiez la cohérence des dates et la capacité." %}
      </p>
      <div class="flex items-center gap-2">
        <button id="submitBtn"
                class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700
                       focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600/60">
          {% trans "Enregistrer" %}
        </button>
        <a href="{% url 'staff:mission_list' %}"
           class="px-4 py-2 rounded-lg ring-1 ring-slate-200 hover:bg-slate-50
                  dark:ring-white/10 dark:hover:bg-white/5">
          {% trans "Annuler" %}
        </a>
      </div>
    </div>
  </form>
</section>

<!-- UX helpers (dates, capacité, aperçu événement, anti double-submit) -->
<script>
(function(){
  const form   = document.getElementById('mission-form');
  const submit = document.getElementById('submitBtn');

  const start  = document.getElementById('{{ form.start_date.id_for_label }}');
  const end    = document.getElementById('{{ form.end_date.id_for_label }}');
  const cap    = document.getElementById('{{ form.capacity.id_for_label }}');
  const evSel  = document.getElementById('{{ form.event.id_for_label }}');
  const evOut  = document.getElementById('eventPreview');

  // Helpers date/datetime
  const isDateTime = (el) => el && el.type === 'datetime-local';
  const pad = (n)=> String(n).padStart(2,'0');
  const normalize = (el, d) => {
    if (!el) return '';
    const yyyy = d.getFullYear();
    const mm   = pad(d.getMonth()+1);
    const dd   = pad(d.getDate());
    if (isDateTime(el)) {
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }
    return `${yyyy}-${mm}-${dd}`;
  };
  const parseValue = (el) => {
    if (!el || !el.value) return null;
    const v = el.value.replace(' ', 'T');
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  };

  // Fin ≥ Début + auto-fill
  function clampEnd(){
    if (!start || !end) return;
    const sd = parseValue(start);
    const ed = parseValue(end);
    if (sd) {
      end.min = normalize(end, sd);
      if (!ed || ed < sd) {
        end.value = normalize(end, sd);
      }
    } else {
      end.removeAttribute('min');
    }
  }
  start && start.addEventListener('change', clampEnd);
  end   && end.addEventListener('change', clampEnd);
  clampEnd();

  // Capacité min=0 + clamp
  if (cap) {
    cap.addEventListener('input', () => {
      const n = parseInt(cap.value || '0', 10);
      if (isNaN(n) || n < 0) cap.value = 0;
    });
  }

  // Aperçu événement choisi
  function updateEventPreview(){
    if (!evSel || !evOut) return;
    const opt = evSel.selectedOptions && evSel.selectedOptions[0];
    const label = opt ? opt.textContent.trim() : '';
    evOut.textContent = label ? `Événement sélectionné : ${label}` : '';
  }
  evSel && evSel.addEventListener('change', updateEventPreview);
  updateEventPreview();

  // Anti double-submit + “modifs non enregistrées”
  let dirty = false;
  if (form) {
    form.addEventListener('input', ()=> { dirty = true; }, { once: true });

    form.addEventListener('submit', () => {
      if (submit && !submit.disabled) {
        submit.disabled = true;
        submit.dataset.originalText = submit.textContent;
        submit.textContent = 'Enregistrement…';
      }
      dirty = false;
    });

    window.addEventListener('beforeunload', (e) => {
      if (dirty) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  }
})();
</script>
{% endblock %}
