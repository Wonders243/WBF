{% extends "staff/base_staff.html" %}
{% block staff_title %}Staff — Mission : {{ mission.title }}{% endblock %}

{% block staff_content %}
<section class="space-y-6">

  <!-- Header -->
  <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-extrabold text-blue-700 dark:text-blue-300">{{ mission.title }}</h1>

      {# Lien vers l'événement parent si disponible #}
      <p class="mt-1 text-sm">
        {% if mission.event %}
          <a class="text-blue-600 dark:text-blue-300 hover:underline"
             href="{% url 'staff:event_detail' mission.event.id %}">
            Événement associé : {{ mission.event.title }}
          </a>
        {% elif mission.event_title and mission.event_id %}
          <a class="text-blue-600 dark:text-blue-300 hover:underline"
             href="{% url 'staff:event_detail' mission.event_id %}">
            Événement associé : {{ mission.event_title }}
          </a>
        {% else %}
          <span class="text-slate-500 dark:text-slate-400">Aucun événement associé</span>
        {% endif %}
      </p>

      <p class="text-slate-600 dark:text-slate-300">
        {{ mission.start_date|default:"Date à confirmer" }}{% if mission.end_date %} → {{ mission.end_date }}{% endif %}
        · {{ mission.location|default:"Lieu à confirmer" }}
      </p>
    </div>

    <div class="flex flex-wrap gap-2">
      <a href="{% url 'staff:mission_invite' mission.id %}"
         class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600/60">
        Inviter des bénévoles à la mission
      </a>

      <a href="{% url 'staff:mission_update' mission.pk %}"
         class="px-4 py-2 rounded-lg ring-1 ring-slate-200 hover:bg-slate-50 dark:ring-white/10 dark:hover:bg-white/5">
        Éditer
      </a>

      <form method="post" action="#" class="inline">
        {% csrf_token %}
        <button class="px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-600/60">
          Publier / Archiver
        </button>
      </form>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Détails -->
    <article class="lg:col-span-2 bg-white dark:bg-slate-900 rounded-2xl shadow ring-1 ring-black/5 dark:ring-white/10 p-6">
      <h2 class="text-lg font-semibold mb-3 text-slate-900 dark:text-slate-100">Détails</h2>
      <p class="text-slate-800 dark:text-slate-200 whitespace-pre-line">
        {{ mission.description|default:"(Aucune description)" }}
      </p>
    </article>

    <!-- Stats -->
    <aside class="space-y-3">
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow ring-1 ring-black/5 dark:ring-white/10 p-4">
        <div class="text-sm text-slate-500 dark:text-slate-400">Capacité</div>
        <div class="text-2xl font-extrabold text-slate-900 dark:text-slate-100">{{ mission.capacity|default:"—" }}</div>
      </div>
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow ring-1 ring-black/5 dark:ring-white/10 p-4">
        <div class="text-sm text-slate-500 dark:text-slate-400">Inscriptions</div>
        <div class="text-2xl font-extrabold text-slate-900 dark:text-slate-100">{{ counts.total|default:0 }}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">
          Acceptées : {{ counts.accepted|default:0 }} · En attente : {{ counts.pending|default:0 }}
        </div>
      </div>
    </aside>
  </div>

  <!-- Inscriptions -->
  <section class="bg-white dark:bg-slate-900 rounded-2xl shadow ring-1 ring-black/5 dark:ring-white/10 p-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Inscriptions</h2>
      <form method="post" action="#" class="flex gap-2">
        {% csrf_token %}
        <input type="text" name="invite" placeholder="Email / nom bénévole"
               class="w-64 px-3 py-2 rounded-lg border border-slate-300 dark:border-white/10
                      bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 placeholder-slate-400
                      focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20">
        <button class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700
                       focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600/60">
          Inviter
        </button>
      </form>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      {% for bloc in signups_by_status %}
        <div class="rounded-2xl ring-1 ring-slate-200 dark:ring-white/10 overflow-hidden bg-white dark:bg-slate-900">
          <div class="px-3 py-2 font-semibold bg-gray-50 dark:bg-slate-800/60 text-slate-900 dark:text-slate-100">
            {{ bloc.label }} ({{ bloc.items|length }})
          </div>
          <ul class="divide-y divide-slate-200 dark:divide-white/10">
            {% for s in bloc.items %}
              <li class="p-3 flex items-center justify-between">
                <div class="min-w-0">
                  <p class="font-medium truncate text-slate-900 dark:text-slate-100">{{ s.volunteer_name }}</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">{{ s.created_at }}</p>
                </div>

                <div class="flex gap-2">
                  {# ---- LOGIQUE D’ACTIONS ---- #}
                  {% if bloc.key == 'pending' %}
                    {# Candidat a postulé → accepter/refuser #}
                    <form method="post" action="{% url 'staff:staff_signup_accept' s.id %}" class="inline">
                      {% csrf_token %}
                      <button class="px-2 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700">Accepter</button>
                    </form>
                    <form method="post" action="{% url 'staff:staff_signup_decline' s.id %}" class="inline">
                      {% csrf_token %}
                      <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-700">Refuser</button>
                    </form>

                  {% elif bloc.key == 'invited' %}
                    {# Staff a invité → seulement annuler l’invitation #}
                    <form method="post" action="{% url 'staff:mission_cancel_invite' s.id %}" class="inline">
                      {% csrf_token %}
                      <button class="px-2 py-1 text-xs rounded bg-amber-600 text-white hover:bg-amber-700">
                        Annuler l’invitation
                      </button>
                    </form>

                  {% else %}
                    <span class="text-xs text-slate-500 dark:text-slate-400">Aucune action</span>
                  {% endif %}
                </div>
              </li>
            {% empty %}
              <li class="p-3 text-sm text-slate-500 dark:text-slate-400">—</li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  </section>

</section>
{% endblock %}
