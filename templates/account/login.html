{% extends "account/base.html" %}
{% load i18n static socialaccount widget_tweaks %}

{# File: templates/account/login.html #}

{% block title %}{% trans "Connexion ‚Äî  BAMU WELLBEING Foundation" %}{% endblock %}

{% block auth_heading %}
  <h1 id="page-title" class="text-2xl sm:text-3xl font-extrabold tracking-tight text-blue-700 dark:text-blue-300 text-center">
    {% trans "Bienvenue üëã" %}
  </h1>
  <p class="mt-1 text-sm text-slate-600 dark:text-slate-300/80 text-center">
    {% trans "Connectez-vous √† votre espace personnel" %}
  </p>
{% endblock %}

{% block account_content %}
  {# Non-field errors (ex: identifiants invalides) #}
  {% if form.non_field_errors %}
    <div class="mb-4 text-sm rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-red-700 dark:bg-red-950/40 dark:text-red-200 dark:border-red-900/40 text-center">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  <form method="post" action="{% url 'account_login' %}" enctype="multipart/form-data" class="space-y-4" novalidate>
    {% csrf_token %}

    {# Hidden redirect field (Allauth) #}
    {% if redirect_field_value %}
      <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}">
    {% endif %}

    {# Login #}
    <div class="relative">
      <label for="id_login" class="mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200">
        {% trans "Email ou nom d‚Äôutilisateur" %}
      </label>
      <div class="relative">
        <input
          type="text"
          name="login"
          id="id_login"
          value="{{ form.login.value|default_if_none:'' }}"
          autocomplete="username"
          required
          aria-invalid="{% if form.login.errors %}true{% else %}false{% endif %}"
          aria-describedby="{% if form.login.errors %}id_login_error{% endif %}"
          class="w-full rounded-xl border border-slate-300 bg-white/80 px-3 py-2.5 pr-10 shadow-sm outline-none transition focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:bg-white/10 dark:border-white/10 dark:focus:ring-blue-500/20"
        />
        <svg aria-hidden="true" class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M2 7l10 6 10-6"/><path d="M2 17l10 6 10-6"/>
        </svg>
      </div>
      {% if form.login.errors %}
        <p id="id_login_error" class="mt-1 text-sm text-red-600">{{ form.login.errors|striptags }}</p>
      {% endif %}
    </div>

    {# Password + toggle #}
    <div class="relative">
      <label for="id_password" class="mb-1 block text-sm font-medium text-slate-700 dark:text-slate-200">
        {% trans "Mot de passe" %}
      </label>
      <div class="relative">
        <input
          type="password"
          name="password"
          id="id_password"
          autocomplete="current-password"
          required
          aria-invalid="{% if form.password.errors %}true{% else %}false{% endif %}"
          aria-describedby="{% if form.password.errors %}id_password_error{% endif %}"
          class="w-full rounded-xl border border-slate-300 bg-white/80 px-3 py-2.5 pr-12 shadow-sm outline-none transition focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:bg-white/10 dark:border-white/10 dark:focus:ring-blue-500/20"
        />
        <button type="button" id="togglePassword" class="absolute right-2.5 top-1/2 -translate-y-1/2 inline-flex items-center rounded-lg px-2 py-1 text-xs font-medium text-slate-600 hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600/60 dark:text-slate-300">
          <svg id="eyeIcon" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/>
          </svg>
          <span class="sr-only">{% trans "Afficher/masquer le mot de passe" %}</span>
        </button>
      </div>
      {% if form.password.errors %}
        <p id="id_password_error" class="mt-1 text-sm text-red-600">{{ form.password.errors|striptags }}</p>
      {% endif %}

      <div class="mt-2 flex items-center justify-between text-sm">
        <div class="flex items-center gap-2">
          {% if form.remember %}
            <label class="inline-flex items-center gap-2 select-none">
              {{ form.remember|add_class:"h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" }}
              <span class="text-slate-600 dark:text-slate-300">{% trans "Se souvenir de moi" %}</span>
            </label>
          {% endif %}
        </div>
        <a href="{% url 'account_reset_password' %}" class="text-blue-700 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-200 font-medium">
          {% trans "Mot de passe oubli√© ?" %}
        </a>
      </div>
    </div>

    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-2.5 font-semibold text-white shadow hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600/60">
      <span>{% trans "Se connecter" %}</span>
    </button>
  </form>

  {# Social login (affiche seulement ce qui est configur√©) #}
  {% get_providers as socialaccount_providers %}
  {% if socialaccount_providers %}
    <div class="my-6 flex items-center gap-4">
      <div class="h-px w-full bg-slate-200 dark:bg-white/10"></div>
      <span class="shrink-0 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">{% trans "ou" %}</span>
      <div class="h-px w-full bg-slate-200 dark:bg-white/10"></div>
    </div>

    <div class="grid grid-cols-1 gap-3">
      {% for provider in socialaccount_providers %}
        <a href="{% provider_login_url provider.id %}"
           class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2.5 font-medium text-slate-800 shadow-sm hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600/60 dark:bg-white/10 dark:text-slate-100 dark:border-white/10">
          {# Ic√¥ne sp√©cifique si Google, sinon g√©n√©rique #}
          {% if provider.id == "google" %}
            <svg aria-hidden="true" class="h-5 w-5" viewBox="0 0 48 48">
              <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.9 32.6 29.4 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.6 6.1 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10 0 19-7.3 19-20 0-1.1-.1-2.2-.4-3.5z"/>
              <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.9 16.2 19.1 14 24 14c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.6 6.1 29.6 4 24 4 16 4 9.1 8.5 6.3 14.7z"/>
              <path fill="#4CAF50" d="M24 44c5.3 0 10.2-2 13.8-5.2l-6.4-5.2C29.3 35.7 26.8 36.7 24 36c-5.3 0-9.8-3.4-11.5-8.1l-6.5 5C8.8 39.4 15.9 44 24 44z"/>
              <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.7-4.8 6.5-9.3 6.5-5.3 0-9.8-3.4-11.5-8.1l-6.5 5C10.2 38.6 17.3 44 24 44c10 0 19-7.3 19-20 0-1.1-.1-2.2-.4-3.5z"/>
            </svg>
          {% elif provider.id == "github" %}
            <svg aria-hidden="true" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .5a12 12 0 0 0-3.8 23.4c.6.1.8-.2.8-.5v-2c-3.3.7-4-1.6-4-1.6-.6-1.5-1.4-1.9-1.4-1.9-1.1-.8.1-.8.1-.8 1.2.1 1.8 1.2 1.8 1.2 1 1.8 2.7 1.3 3.4 1 .1-.8.4-1.3.7-1.6-2.6-.3-5.2-1.3-5.2-5.9 0-1.3.5-2.3 1.2-3.2-.1-.3-.5-1.6.1-3.3 0 0 1-.3 3.3 1.2a11.4 11.4 0 0 1 6 0C18.3 6.3 19.4 6.6 19.4 6.6c.6 1.7.2 3 .1 3.3.8.9 1.2 1.9 1.2 3.2 0 4.6-2.7 5.6-5.2 5.9.4.3.8 1 .8 2v3c0 .3.2.6.8.5A12 12 0 0 0 12 .5z"/></svg>
          {% else %}
            <svg aria-hidden="true" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
          {% endif %}
          <span>{% blocktrans %}Continuer avec {{ provider.name }}{% endblocktrans %}</span>
        </a>
      {% endfor %}
    </div>
  {% endif %}

  <p class="mt-6 text-center text-sm text-slate-600 dark:text-slate-300/90">
    {% trans "Pas encore inscrit ?" %}
    <a href="{% url 'account_signup' %}" class="font-medium text-blue-700 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-200">
      {% trans "Cr√©er un compte" %}
    </a>
  </p>
{% endblock %}

{% block scripts %}
  <script>
    (function(){
      const btn = document.getElementById('togglePassword');
      if(!btn) return;
      const input = document.getElementById('id_password');
      const icon  = document.getElementById('eyeIcon');
      btn.addEventListener('click', function(){
        const isPwd = input.getAttribute('type') === 'password';
        input.setAttribute('type', isPwd ? 'text' : 'password');
        // Swap icon (eye / eye-off)
        icon.innerHTML = isPwd
          ? '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/><path d="M3 3l18 18"/>'
          : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/>';
      });
    })();
  </script>
{% endblock %}
