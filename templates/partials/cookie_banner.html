<div id="cookie-banner" class="fixed bottom-4 left-4 right-4 z-40 md:right-auto md:left-8 md:max-w-md hidden" data-cookie-name="wbf_cookie_preferences" data-cookie-max-age="15552000">
  <div class="rounded-xl border border-slate-200 bg-white/95 p-4 shadow-lg backdrop-blur-sm dark:border-white/10 dark:bg-slate-900/90">
    <h2 class="text-sm font-semibold text-slate-800 dark:text-slate-100">Cookies et confidentialité</h2>
    <p class="mt-2 text-xs leading-relaxed text-slate-600 dark:text-slate-300">
      Nous utilisons des cookies nécessaires au fonctionnement du site. Les cookies d’analyse ne sont activés qu’avec votre accord.
      <a href="{% url 'legal:cookies' %}" class="text-blue-700 underline hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-200">En savoir plus</a>
    </p>
    <div class="mt-3 flex flex-wrap gap-2">
      <button type="button" data-cookie-accept-all class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white shadow hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/60">Tout accepter</button>
      <button type="button" data-cookie-reject-all class="inline-flex items-center justify-center rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/40 dark:border-white/10 dark:text-slate-200 dark:hover:bg-slate-800">Tout refuser</button>
      <button type="button" data-cookie-manage class="ml-auto inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-sm font-medium text-blue-700 hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/40 dark:text-blue-300 dark:hover:bg-slate-800/70">Personnaliser</button>
    </div>
  </div>
</div>

<div id="cookie-preferences" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="cookie-preferences-title">
  <div class="absolute inset-0 bg-slate-900/55 backdrop-blur-sm" data-cookie-close></div>
  <div class="relative mx-auto mt-24 w-full max-w-xl px-4">
    <div class="rounded-2xl border border-slate-200 bg-white/98 shadow-xl dark:border-white/10 dark:bg-slate-950/95">
      <div class="flex items-start justify-between gap-3 border-b border-slate-200 px-5 py-4 dark:border-white/10">
        <div>
          <h2 id="cookie-preferences-title" class="text-lg font-semibold text-slate-900 dark:text-slate-100">Préférences cookies</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300">Choisissez les catégories que nous pouvons activer.</p>
        </div>
        <button type="button" data-cookie-close class="inline-flex h-8 w-8 items-center justify-center rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/60 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">
          <span class="sr-only">Fermer</span>
          <svg viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5" aria-hidden="true"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
        </button>
      </div>
      <div class="space-y-4 px-5 py-4 text-sm text-slate-700 dark:text-slate-200">
        <div class="flex items-start gap-3 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 dark:border-white/10 dark:bg-slate-900/60">
          <input type="checkbox" checked disabled class="mt-1 h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
          <div>
            <p class="font-medium">Cookies nécessaires</p>
            <p class="text-xs leading-5 text-slate-600 dark:text-slate-300">Indispensables pour la sécurité et la connexion. Toujours actifs.</p>
          </div>
        </div>
        <div class="flex items-start gap-3 rounded-lg border border-slate-200 px-4 py-3 dark:border-white/10">
          <input type="checkbox" name="cookie-analytics" class="mt-1 h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
          <div>
            <p class="font-medium">Mesure d’audience</p>
            <p class="text-xs leading-5 text-slate-600 dark:text-slate-300">Nous aide à améliorer le site. Activée uniquement si vous l’autorisez.</p>
          </div>
        </div>
      </div>
      <div class="flex flex-wrap items-center justify-end gap-2 border-t border-slate-200 px-5 py-4 dark:border-white/10">
        <button type="button" data-cookie-reject-all class="inline-flex items-center justify-center rounded-lg border border-slate-300 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/40 dark:border-white/10 dark:text-slate-200 dark:hover:bg-slate-800">Tout refuser</button>
        <button type="button" data-cookie-accept-all class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-medium text-white shadow hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/60">Tout accepter</button>
        <button type="button" data-cookie-save class="inline-flex items-center justify-center rounded-lg bg-blue-500 px-3 py-2 text-sm font-medium text-white shadow hover:bg-blue-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/60">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const banner = document.getElementById('cookie-banner');
  const dialog = document.getElementById('cookie-preferences');
  if (!banner || !dialog) {
    return;
  }

  const COOKIE_NAME = banner.getAttribute('data-cookie-name') || 'wbf_cookie_preferences';
  const MAX_AGE = parseInt(banner.getAttribute('data-cookie-max-age') || '15552000', 10); // 180 jours
  const analyticsToggle = dialog.querySelector('input[name="cookie-analytics"]');
  const manageTriggers = document.querySelectorAll('[data-cookie-manage], #cookies-settings');

  function parseCookieValue(raw) {
    try {
      return raw ? JSON.parse(raw) : null;
    } catch (err) {
      return null;
    }
  }

  function getCookie() {
    const match = document.cookie.match(new RegExp('(?:^|; )' + COOKIE_NAME.replace(/[.*+?^${}()|[\]\]/g, '\$&') + '=([^;]*)'));
    return match ? parseCookieValue(decodeURIComponent(match[1])) : null;
  }

  function writeCookie(prefs) {
    const value = encodeURIComponent(JSON.stringify(prefs));
    let parts = [COOKIE_NAME + '=' + value, 'Max-Age=' + MAX_AGE, 'Path=/', 'SameSite=Lax'];
    if (location.protocol === 'https:') {
      parts.push('Secure');
    }
    document.cookie = parts.join('; ');
  }

  function applyPrefsToForm(prefs) {
    if (!analyticsToggle) {
      return;
    }
    analyticsToggle.checked = !!prefs.analytics;
  }

  function closeDialog() {
    dialog.classList.add('hidden');
    document.documentElement.classList.remove('overflow-hidden');
  }

  function openDialog() {
    applyPrefsToForm(getCookie() || {necessary: true, analytics: false});
    dialog.classList.remove('hidden');
    document.documentElement.classList.add('overflow-hidden');
  }

  function savePreferences(prefs) {
    writeCookie(prefs);
    banner.classList.add('hidden');
    closeDialog();
  }

  function acceptAll() {
    savePreferences({necessary: true, analytics: true, consented_at: new Date().toISOString()});
  }

  function rejectAll() {
    savePreferences({necessary: true, analytics: false, consented_at: new Date().toISOString()});
  }

  function handleSaveClick() {
    const prefs = {
      necessary: true,
      analytics: analyticsToggle ? !!analyticsToggle.checked : false,
      consented_at: new Date().toISOString()
    };
    savePreferences(prefs);
  }

  banner.querySelectorAll('[data-cookie-accept-all]').forEach((btn) => {
    btn.addEventListener('click', acceptAll);
  });
  banner.querySelectorAll('[data-cookie-reject-all]').forEach((btn) => {
    btn.addEventListener('click', rejectAll);
  });
  banner.querySelectorAll('[data-cookie-manage]').forEach((btn) => {
    btn.addEventListener('click', (event) => {
      event.preventDefault();
      openDialog();
    });
  });

  dialog.querySelectorAll('[data-cookie-accept-all]').forEach((btn) => {
    btn.addEventListener('click', acceptAll);
  });
  dialog.querySelectorAll('[data-cookie-reject-all]').forEach((btn) => {
    btn.addEventListener('click', rejectAll);
  });
  dialog.querySelectorAll('[data-cookie-save]').forEach((btn) => {
    btn.addEventListener('click', handleSaveClick);
  });
  dialog.querySelectorAll('[data-cookie-close]').forEach((btn) => {
    btn.addEventListener('click', (event) => {
      event.preventDefault();
      closeDialog();
    });
  });

  manageTriggers.forEach((el) => {
    el.addEventListener('click', (event) => {
      event.preventDefault();
      openDialog();
    });
  });

  window.cookieConsent = {
    open: openDialog,
    showPreferences: openDialog,
    getPreferences: getCookie,
  };

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      closeDialog();
    }
  });

  const existingPrefs = getCookie();
  if (!existingPrefs) {
    banner.classList.remove('hidden');
  } else {
    applyPrefsToForm(existingPrefs);
  }
})();
</script>
